name: QoE-Guard API Validation

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      baseline_url:
        description: 'Baseline API URL'
        required: false
      candidate_url:
        description: 'Candidate API URL'
        required: false

env:
  PYTHON_VERSION: '3.11'

# Required for GitHub Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    name: Run Tests with Allure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-ci.txt
      
      - name: Install Allure CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre
          wget -q https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -xzf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure
          allure --version
      
      - name: Run tests with coverage and Allure
        run: |
          pytest tests/test_unit_pytest.py tests/test_integration_pytest.py tests/test_e2e_pytest.py \
            -v \
            --cov=qoe_guard \
            --cov-report=term-missing \
            --cov-report=xml \
            --alluredir=allure-results \
            || true
        continue-on-error: true
      
      - name: Generate Allure Report
        if: always()
        run: |
          allure generate allure-results -o allure-report --clean
      
      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 30
      
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30
      
      - name: Deploy Allure Report to GitHub Pages
        if: github.ref == 'refs/heads/main' && always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          destination_dir: allure-report
        continue-on-error: true

  validate:
    name: QoE Validation
    runs-on: ubuntu-latest
    needs: test
    
    outputs:
      decision: ${{ steps.qoe.outputs.decision }}
      risk_score: ${{ steps.qoe.outputs.risk_score }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-ci.txt
      
      - name: Run QoE-Guard validation
        id: qoe
        run: |
          python -m qoe_guard.cli validate \
            --baseline tests/fixtures/baseline.json \
            --candidate tests/fixtures/candidate.json \
            --format github
        continue-on-error: true
      
      - name: Create validation summary
        run: |
          echo "## QoE-Guard Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Decision | ${{ steps.qoe.outputs.decision || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Risk Score | ${{ steps.qoe.outputs.risk_score || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Fail on FAIL decision
        if: steps.qoe.outputs.decision == 'FAIL'
        run: |
          echo "::error::QoE-Guard validation FAILED"
          exit 1

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: validate
    if: always() && needs.validate.outputs.decision == 'FAIL'
    
    steps:
      - name: Slack notification (on failure)
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš¨ QoE-Guard FAIL",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*QoE-Guard Validation Failed*\nâ€¢ Risk Score: ${{ needs.validate.outputs.risk_score }}\nâ€¢ PR: ${{ github.event.pull_request.html_url || github.event.head_commit.url }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
