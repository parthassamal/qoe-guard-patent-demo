<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Swagger Analyzer - QoE-Guard</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c1526;
      --text:#e7eefc;
      --muted:#a9b7d3;
      --border:rgba(231,238,252,.12);
      --accent:#7aa2ff;
      --good:#6ee7a8;
      --bad:#ff7a7a;
      --warn:#ffd37a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.35), transparent 60%),
                  radial-gradient(800px 500px at 90% 0%, rgba(110,231,168,.18), transparent 55%),
                  var(--bg);
      color: var(--text);
      line-height:1.35;
    }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .container{ max-width: 1200px; margin: 0 auto; padding: 28px 16px 60px; }
    .header{ display:flex; gap:16px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; margin-bottom: 24px; }
    .title{ margin:0; font-size: 28px; letter-spacing:.2px; }
    .subtitle{ margin:6px 0 0; color:var(--muted); }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    .card h2{ margin:0 0 16px; font-size: 18px; letter-spacing: .2px; }
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding: 12px 20px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(122,162,255,.18);
      border-color: rgba(122,162,255,.45);
      color: var(--text);
      text-decoration:none;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease;
      user-select:none;
      font-size: 14px;
      font-weight: 500;
    }
    .btn:hover{ background: rgba(122,162,255,.25); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity: 0.5; cursor: not-allowed; }
    input, textarea, select{
      width:100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: 12px;
      outline:none;
      font-size: 14px;
      margin-bottom: 12px;
    }
    textarea{ min-height: 80px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    label{ display:block; font-size: 13px; color: var(--muted); margin-bottom: 8px; font-weight: 500; }
    .help{ font-size: 12px; color: var(--muted); margin: -8px 0 12px; }
    .stats{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat{
      background: rgba(0,0,0,.15);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }
    .stat-value{ font-size: 28px; font-weight: bold; margin-bottom: 4px; }
    .stat-label{ font-size: 12px; color: var(--muted); }
    .stat.healthy .stat-value{ color: var(--good); }
    .stat.broken .stat-value{ color: var(--bad); }
    .stat.auth .stat-value{ color: var(--warn); }
    .table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .table th, .table td{
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .table th{
      background: rgba(0,0,0,.2);
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .table td{
      font-size: 13px;
    }
    .status-badge{
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-badge.healthy{ background: rgba(110,231,168,.2); color: var(--good); }
    .status-badge.broken{ background: rgba(255,122,122,.2); color: var(--bad); }
    .status-badge.auth_required{ background: rgba(255,211,122,.2); color: var(--warn); }
    .status-badge.timeout{ background: rgba(255,122,122,.2); color: var(--bad); }
    .recommendations{
      background: rgba(122,162,255,.08);
      border: 1px solid rgba(122,162,255,.25);
      border-radius: 10px;
      padding: 16px;
      margin-top: 20px;
    }
    .recommendations h3{
      margin: 0 0 12px;
      font-size: 14px;
      color: var(--accent);
    }
    .recommendations ul{
      margin: 0;
      padding-left: 20px;
    }
    .recommendations li{
      margin-bottom: 8px;
      font-size: 13px;
    }
    .loading{
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
    .spinner{
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin{
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .checkbox-group{
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .checkbox-group input[type="checkbox"]{
      width: auto;
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 class="title">üîç Swagger/OpenAPI Analyzer</h1>
        <p class="subtitle">Test all endpoints in your Swagger spec for broken links, auth issues, and timeouts</p>
      </div>
      <a href="/" class="btn">‚Üê Back to QoE-Guard</a>
    </div>

    <div class="card">
      <h2>Analyze Swagger Specification</h2>
      <form id="analyzeForm">
        <label>Swagger/OpenAPI URL</label>
        <input type="url" name="swagger_url" placeholder="https://api.example.com/openapi.json" required />
        <div class="help">URL to your OpenAPI spec (JSON or YAML). Can be /docs, /openapi.json, or /swagger.json</div>

        <label>Base URL (optional override)</label>
        <input type="text" name="base_url" placeholder="https://api.example.com" />
        <div class="help">Override the base URL from the spec. Leave empty to use spec's servers[0].url</div>

        <label>Headers (JSON, optional)</label>
        <textarea name="headers_json" placeholder='{"Authorization": "Bearer token"}'></textarea>
        <div class="help">Optional headers for authenticated endpoints</div>

        <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label>Timeout (seconds)</label>
            <input type="number" name="timeout" value="10" min="1" max="60" />
          </div>
          <div class="checkbox-group" style="align-items: flex-end; padding-top: 8px;">
            <input type="checkbox" name="test_all" id="test_all" />
            <label for="test_all" style="margin: 0;">Test all methods (not just GET)</label>
          </div>
        </div>

        <button type="submit" class="btn" id="submitBtn">Analyze Endpoints</button>
      </form>
    </div>

    <div id="results" style="display: none;">
      <div class="card">
        <h2>Analysis Results</h2>
        <div class="stats" id="stats"></div>
        <div class="recommendations" id="recommendations"></div>
      </div>

      <div class="card">
        <h2>Endpoint Details</h2>
        <table class="table" id="endpointsTable">
          <thead>
            <tr>
              <th>Method</th>
              <th>Path</th>
              <th>Status</th>
              <th>Status Code</th>
              <th>Response Time</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody id="endpointsBody"></tbody>
        </table>
      </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <div>Analyzing endpoints...</div>
    </div>
  </div>

  <script>
    document.getElementById('analyzeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = document.getElementById('submitBtn');
      const results = document.getElementById('results');
      const loading = document.getElementById('loading');
      
      submitBtn.disabled = true;
      results.style.display = 'none';
      loading.style.display = 'block';
      
      const formData = new FormData(form);
      const data = {
        swagger_url: formData.get('swagger_url'),
        base_url: formData.get('base_url') || '',
        headers_json: formData.get('headers_json') || '{}',
        timeout: parseInt(formData.get('timeout') || '10'),
        test_all: formData.get('test_all') === 'on',
      };
      
      try {
        const resp = await fetch('/api/swagger/analyze', {
          method: 'POST',
          body: new URLSearchParams(data),
        });
        
        if (!resp.ok) {
          const error = await resp.json();
          throw new Error(error.error || 'Analysis failed');
        }
        
        const analysis = await resp.json();
        displayResults(analysis);
        
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        loading.style.display = 'none';
      }
    });
    
    function displayResults(analysis) {
      // Stats
      const statsHtml = `
        <div class="stat healthy">
          <div class="stat-value">${analysis.healthy_count}</div>
          <div class="stat-label">Healthy</div>
        </div>
        <div class="stat broken">
          <div class="stat-value">${analysis.broken_count}</div>
          <div class="stat-label">Broken</div>
        </div>
        <div class="stat auth">
          <div class="stat-value">${analysis.auth_required_count}</div>
          <div class="stat-label">Auth Required</div>
        </div>
        <div class="stat">
          <div class="stat-value">${analysis.tested_endpoints}</div>
          <div class="stat-label">Tested</div>
        </div>
      `;
      document.getElementById('stats').innerHTML = statsHtml;
      
      // Recommendations
      if (analysis.recommendations && analysis.recommendations.length > 0) {
        const recsHtml = `
          <h3>Recommendations</h3>
          <ul>
            ${analysis.recommendations.map(r => `<li>${r}</li>`).join('')}
          </ul>
        `;
        document.getElementById('recommendations').innerHTML = recsHtml;
      }
      
      // Endpoints table
      const tbody = document.getElementById('endpointsBody');
      tbody.innerHTML = analysis.endpoint_tests.map(test => `
        <tr>
          <td><code>${test.method}</code></td>
          <td><code>${test.path}</code></td>
          <td><span class="status-badge ${test.status}">${test.status}</span></td>
          <td>${test.status_code || '-'}</td>
          <td>${test.response_time_ms ? test.response_time_ms.toFixed(0) + 'ms' : '-'}</td>
          <td style="color: var(--muted); font-size: 12px;">${test.error_message || '-'}</td>
        </tr>
      `).join('');
      
      document.getElementById('results').style.display = 'block';
    }
  </script>
</body>
</html>
